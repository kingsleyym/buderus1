<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newsletter Dashboard | Buderus Systeme</title>
    <meta name="theme-color" content="#181A23">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/favicon-ico-data.ico">
    
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/admin/admin.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="admin-body">
    <!-- Mobile Navigation Toggle -->
    <button class="mobile-nav-toggle" id="mobileNavToggle">☰</button>
    
    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="admin-dashboard">
        <!-- Sidebar -->
        <nav class="admin-sidebar">
            <div class="sidebar-header">
                <img src="/assets/logo.png" alt="Buderus Systeme" class="sidebar-logo">
                <h2 class="sidebar-title">Admin Dashboard</h2>
                <p class="sidebar-subtitle">Newsletter Management</p>
            </div>
            
            <div class="sidebar-nav">
                <a href="/admin/dashboard.html" class="nav-item active">
                    <i>📊</i> Dashboard
                </a>
                <a href="/admin/newsletter-editor.html" class="nav-item">
                    <i>✏️</i> Newsletter erstellen
                </a>
                <a href="/admin/subscribers.html" class="nav-item">
                    <i>👥</i> Abonnenten
                </a>
                <a href="/admin/campaigns.html" class="nav-item">
                    <i>📧</i> Kampagnen
                </a>
                <a href="/admin/qr-codes.html" class="nav-item">
                    <i>📱</i> QR-Codes
                </a>
                <a href="/admin/rewards.html" class="nav-item">
                    <i>🎁</i> Belohnungen
                </a>
                <a href="/admin/analytics.html" class="nav-item">
                    <i>📈</i> Statistiken
                </a>
            </div>
            
            <div class="sidebar-footer">
                <button id="logoutBtn" class="logout-btn">
                    <i>🚪</i> Abmelden
                </button>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="admin-main">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Dashboard</h1>
                <p class="dashboard-subtitle">Willkommen zurück! Hier ist eine Übersicht Ihrer Newsletter-Aktivitäten.</p>
            </div>
            
            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon subscribers">👥</div>
                    </div>
                    <h3 class="stat-value" id="totalSubscribers">-</h3>
                    <p class="stat-label">Abonnenten</p>
                    <p class="stat-change positive" id="subscribersChange">+0 diese Woche</p>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon emails">📧</div>
                    </div>
                    <h3 class="stat-value" id="totalEmails">-</h3>
                    <p class="stat-label">Newsletter versendet</p>
                    <p class="stat-change positive" id="emailsChange">+0 diesen Monat</p>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon opens">📖</div>
                    </div>
                    <h3 class="stat-value" id="avgOpenRate">-%</h3>
                    <p class="stat-label">Öffnungsrate</p>
                    <p class="stat-change positive" id="openRateChange">+0% vs. letzter Monat</p>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon clicks">🎁</div>
                    </div>
                    <h3 class="stat-value" id="rewardsClaimed">-</h3>
                    <p class="stat-label">Belohnungen eingelöst</p>
                    <p class="stat-change positive" id="rewardsChange">+0 diese Woche</p>
                </div>
            </div>
            
            <!-- Content Grid -->
            <div class="content-grid">
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">Schnellaktionen</h3>
                    </div>
                    <div class="card-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <button id="addManualSubscriber" class="btn btn-primary">
                                ➕ E-Mail manuell hinzufügen
                            </button>
                            <a href="/admin/newsletter-editor.html" class="btn btn-primary">
                                ✏️ Newsletter erstellen
                            </a>
                            <a href="/admin/subscribers.html" class="btn btn-secondary">
                                👥 Abonnenten verwalten
                            </a>
                            <button id="sendTestEmail" class="btn btn-success">
                                📧 Test-E-Mail senden
                            </button>
                            <a href="/admin/rewards.html" class="btn btn-primary">
                                🎁 Belohnungen verwalten
                            </a>
                        </div>
                        
                        <div class="alert alert-info" style="margin-top: 1.5rem;">
                            <strong>💡 Tipp:</strong> Nutzen Sie das Belohnungssystem, um die Engagement-Rate zu steigern! 
                            Bestätigte Newsletter-Abonnenten erhalten automatisch einen Belohnungscode.
                        </div>
                    </div>
                </div>
                
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">Neueste Aktivitäten</h3>
                    </div>
                    <div class="card-content">
                        <div id="recentActivity" style="font-size: 0.9rem;">
                            <div class="activity-item" style="padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                                <div style="font-weight: 500;">📧 Newsletter versendet</div>
                                <div style="color: #666; font-size: 0.8rem;">vor 2 Stunden</div>
                            </div>
                            <div class="activity-item" style="padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                                <div style="font-weight: 500;">👤 Neue Anmeldung</div>
                                <div style="color: #666; font-size: 0.8rem;">vor 3 Stunden</div>
                            </div>
                            <div class="activity-item" style="padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                                <div style="font-weight: 500;">🎁 Belohnung eingelöst</div>
                                <div style="color: #666; font-size: 0.8rem;">vor 5 Stunden</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal für manuelle E-Mail-Eingabe -->
    <div id="manualSubscriberModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>E-Mail manuell hinzufügen</h3>
                <span class="close" id="closeModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>💡 Hinweis:</strong> Diese Funktion ist für physische Anmeldungen 
                    (Losboxen, Events, persönliche Gespräche) gedacht. Die E-Mail wird direkt 
                    bestätigt und der Kontakt erhält keinen Bestätigungslink.
                </div>
                
                <form id="manualSubscriberForm">
                    <div class="form-group">
                        <label for="manualEmail">E-Mail-Adresse *</label>
                        <input type="email" id="manualEmail" name="email" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="manualFirstName">Vorname</label>
                            <input type="text" id="manualFirstName" name="firstName">
                        </div>
                        <div class="form-group">
                            <label for="manualLastName">Nachname</label>
                            <input type="text" id="manualLastName" name="lastName">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="manualCompany">Unternehmen</label>
                        <input type="text" id="manualCompany" name="company">
                    </div>
                    
                    <div class="form-group">
                        <label for="manualSource">Quelle der Anmeldung</label>
                        <select id="manualSource" name="source">
                            <option value="losbox">Losbox</option>
                            <option value="event">Event/Messe</option>
                            <option value="persoenlich">Persönliches Gespräch</option>
                            <option value="telefon">Telefon</option>
                            <option value="sonstiges">Sonstiges</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="manualNotes">Notizen (optional)</label>
                        <textarea id="manualNotes" name="notes" rows="3" placeholder="Zusätzliche Informationen zur Anmeldung..."></textarea>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" id="cancelModal">Abbrechen</button>
                        <button type="submit" class="btn btn-primary">E-Mail hinzufügen</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-functions.js';
        
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDW_tTYVrU-8pZPqmFcx5BKhgZVs0pTzSQ",
            authDomain: "buderus-systeme.firebaseapp.com",
            projectId: "buderus-systeme",
            storageBucket: "buderus-systeme.firebasestorage.app",
            messagingSenderId: "384964671486",
            appId: "1:384964671486:web:648152b8b7effb95df72af"
        };
        
        // Firebase initialisieren
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);
        
        class AdminDashboard {
            constructor() {
                this.checkAuth();
                this.initializeEventListeners();
                this.loadDashboardData();
            }
            
            checkAuth() {
                onAuthStateChanged(auth, (user) => {
                    if (!user) {
                        window.location.href = '/admin/index.html';
                    }
                });
            }
            
            initializeEventListeners() {
                // Logout button
                document.getElementById('logoutBtn').addEventListener('click', async () => {
                    await signOut(auth);
                    window.location.href = '/admin/index.html';
                });
                
                // Test Email button
                document.getElementById('sendTestEmail').addEventListener('click', () => {
                    this.sendTestEmail();
                });
                
                // Manual subscriber button
                document.getElementById('addManualSubscriber').addEventListener('click', () => {
                    this.openManualSubscriberModal();
                });
                
                // Modal close buttons
                document.getElementById('closeModal').addEventListener('click', () => {
                    this.closeManualSubscriberModal();
                });
                
                document.getElementById('cancelModal').addEventListener('click', () => {
                    this.closeManualSubscriberModal();
                });
                
                // Modal form submit
                document.getElementById('manualSubscriberForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addManualSubscriber();
                });
                
                // Close modal when clicking outside
                document.getElementById('manualSubscriberModal').addEventListener('click', (e) => {
                    if (e.target.id === 'manualSubscriberModal') {
                        this.closeManualSubscriberModal();
                    }
                });
            }
            
            async loadDashboardData() {
                try {
                    await Promise.all([
                        this.loadSubscriberStats(),
                        this.loadCampaignStats(),
                        this.loadRewardStats(),
                        this.loadRecentActivity()
                    ]);
                } catch (error) {
                    console.error('Dashboard Daten Fehler:', error);
                }
            }
            
            async loadSubscriberStats() {
                try {
                    const subscribersRef = collection(db, 'subscribers');
                    const confirmedQuery = query(subscribersRef, where('confirmed', '==', true));
                    const subscriberDocs = await getDocs(confirmedQuery);
                    
                    const totalSubscribers = subscriberDocs.size;
                    document.getElementById('totalSubscribers').textContent = totalSubscribers;
                    
                    // Calculate weekly growth
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                    
                    const recentQuery = query(
                        subscribersRef, 
                        where('confirmed', '==', true),
                        where('confirmedAt', '>=', oneWeekAgo)
                    );
                    const recentDocs = await getDocs(recentQuery);
                    
                    document.getElementById('subscribersChange').textContent = `+${recentDocs.size} diese Woche`;
                    
                } catch (error) {
                    console.error('Subscriber Stats Fehler:', error);
                }
            }
            
            async loadCampaignStats() {
                try {
                    const campaignsRef = collection(db, 'newsletters');
                    const campaignDocs = await getDocs(campaignsRef);
                    
                    document.getElementById('totalEmails').textContent = campaignDocs.size;
                    
                    // This would be calculated based on actual campaign data
                    document.getElementById('avgOpenRate').textContent = '68%';
                    document.getElementById('emailsChange').textContent = `+${campaignDocs.size} diesen Monat`;
                    document.getElementById('openRateChange').textContent = '+12% vs. letzter Monat';
                    
                } catch (error) {
                    console.error('Campaign Stats Fehler:', error);
                }
            }
            
            async loadRewardStats() {
                try {
                    const rewardsRef = collection(db, 'rewards');
                    const claimedQuery = query(rewardsRef, where('claimed', '==', true));
                    const claimedDocs = await getDocs(claimedQuery);
                    
                    document.getElementById('rewardsClaimed').textContent = claimedDocs.size;
                    
                    // Calculate weekly growth
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                    
                    const recentQuery = query(
                        rewardsRef,
                        where('claimed', '==', true),
                        where('claimedAt', '>=', oneWeekAgo)
                    );
                    const recentDocs = await getDocs(recentQuery);
                    
                    document.getElementById('rewardsChange').textContent = `+${recentDocs.size} diese Woche`;
                    
                } catch (error) {
                    console.error('Rewards Stats Fehler:', error);
                }
            }
            
            async loadRecentActivity() {
                try {
                    // This would load from an analytics/activity collection
                    const activity = [
                        { type: 'email', message: 'Newsletter versendet', time: 'vor 2 Stunden' },
                        { type: 'subscriber', message: 'Neue Anmeldung', time: 'vor 3 Stunden' },
                        { type: 'reward', message: 'Belohnung eingelöst', time: 'vor 5 Stunden' }
                    ];
                    
                    const activityHtml = activity.map(item => `
                        <div class="activity-item" style="padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                            <div style="font-weight: 500;">
                                ${item.type === 'email' ? '📧' : item.type === 'subscriber' ? '👤' : '🎁'} 
                                ${item.message}
                            </div>
                            <div style="color: #666; font-size: 0.8rem;">${item.time}</div>
                        </div>
                    `).join('');
                    
                    document.getElementById('recentActivity').innerHTML = activityHtml;
                    
                } catch (error) {
                    console.error('Activity Fehler:', error);
                }
            }
            
            async sendTestEmail() {
                try {
                    const user = auth.currentUser;
                    if (!user) return;
                    
                    const sendTestFunction = httpsCallable(functions, 'sendTestNewsletter');
                    const result = await sendTestFunction({ email: user.email });
                    
                    if (result.data.success) {
                        alert('Test-E-Mail wurde erfolgreich versendet!');
                    } else {
                        alert('Fehler beim Versenden der Test-E-Mail');
                    }
                } catch (error) {
                    console.error('Test Email Fehler:', error);
                    alert('Fehler beim Versenden der Test-E-Mail');
                }
            }
            
            openManualSubscriberModal() {
                document.getElementById('manualSubscriberModal').style.display = 'block';
                document.getElementById('manualEmail').focus();
            }
            
            closeManualSubscriberModal() {
                document.getElementById('manualSubscriberModal').style.display = 'none';
                document.getElementById('manualSubscriberForm').reset();
            }
            
            async addManualSubscriber() {
                try {
                    const formData = new FormData(document.getElementById('manualSubscriberForm'));
                    const subscriberData = {
                        email: formData.get('email'),
                        firstName: formData.get('firstName'),
                        lastName: formData.get('lastName'),
                        company: formData.get('company'),
                        source: formData.get('source'),
                        notes: formData.get('notes')
                    };
                    
                    // Call admin function to add manual subscriber
                    const addManualFunction = httpsCallable(functions, 'addManualSubscriber');
                    const result = await addManualFunction(subscriberData);
                    
                    if (result.data.success) {
                        alert(`E-Mail ${subscriberData.email} wurde erfolgreich hinzugefügt!`);
                        this.closeManualSubscriberModal();
                        this.loadDashboardData(); // Refresh data
                    } else {
                        alert('Fehler beim Hinzufügen der E-Mail');
                    }
                } catch (error) {
                    console.error('Add Manual Subscriber Fehler:', error);
                    if (error.code === 'functions/already-exists') {
                        alert('Diese E-Mail-Adresse ist bereits im System vorhanden.');
                    } else {
                        alert('Fehler beim Hinzufügen der E-Mail: ' + error.message);
                    }
                }
            }
        }
        
        // Initialize dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new AdminDashboard();
            
            // Mobile Navigation
            const mobileNavToggle = document.getElementById('mobileNavToggle');
            const sidebar = document.querySelector('.admin-sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            if (mobileNavToggle && sidebar && sidebarOverlay) {
                // Toggle sidebar
                mobileNavToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('open');
                    sidebarOverlay.classList.toggle('show');
                });
                
                // Close sidebar when overlay is clicked
                sidebarOverlay.addEventListener('click', () => {
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.remove('show');
                });
                
                // Close sidebar when nav item is clicked on mobile
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        if (window.innerWidth <= 768) {
                            sidebar.classList.remove('open');
                            sidebarOverlay.classList.remove('show');
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>
