name: Generate Employee Pages

on:
  repository_dispatch:
    types: [employee_update]
  workflow_dispatch:  # Manuelle AusfÃ¼hrung ermÃ¶glichen

jobs:
  generate-pages:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Generate Employee HTML Pages
      working-directory: ./mitarbeiter
      run: |
        echo "ğŸš€ Starting Employee Page Generation..."
        echo "ğŸ“‹ Employee Update Event Details:"
        echo "Action: ${{ github.event.client_payload.action }}"
        echo "Employee: ${{ github.event.client_payload.employee.firstName }} ${{ github.event.client_payload.employee.lastName }}"
        
        # Check if employees.json exists
        if [ ! -f "employees.json" ]; then
          echo "âš ï¸ employees.json nicht gefunden, erstelle Fallback..."
          echo "[]" > employees.json
        fi
        
        # Generate HTML pages from employees.json
        echo "ğŸ”„ Generiere Employee HTML-Seiten..."
        node generate-employee-pages.js
        
    - name: Commit and Push Changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add generated files
        git add mitarbeiter/*.html
        git add assets/avatars/* || echo "No new avatars to add"
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "âœ… Keine Ã„nderungen zu committen"
        else
          git commit -m "ğŸ¤– Auto-generate employee pages

          - Generated HTML pages for employee profiles
          - Updated employee: ${{ github.event.client_payload.employee.firstName || 'Unknown' }} ${{ github.event.client_payload.employee.lastName || 'Employee' }}
          - Triggered by: ${{ github.event.client_payload.action || 'manual' }}
          
          Files updated:
          - mitarbeiter/*.html
          - employees.json (if updated)"
          
          git push
          
          echo "âœ… Employee-Seiten erfolgreich generiert und deployed!"
        fi
        
    - name: Summary
      run: |
        echo "ğŸ‰ Employee Page Generation Complete!"
        echo "ğŸŒ Updated pages available at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/mitarbeiter/"
        echo "ğŸ“± Individual employee pages:"
        ls mitarbeiter/*.html | grep -v index.html | head -5 || echo "No individual pages found"
